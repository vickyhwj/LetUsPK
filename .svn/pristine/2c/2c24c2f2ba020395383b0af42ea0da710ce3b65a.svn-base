package com.websocket;

import org.springframework.web.context.ContextLoader;

import po.XiangqiGameState;
import po.XiangqiMove;
import mapper.UserMapper;
import net.sf.json.JSONObject;
//ÏÂÒ»²½
public class XiangqiMsg9 implements MsgStrategy{
	UserMapper userMapper= (UserMapper) ContextLoader.getCurrentWebApplicationContext().getBean("userMapper");

	public void dealMsg(JSONObject jsonObject,String username,String gameMapKey) {
		// TODO Auto-generated method stub
		try{
			String to=jsonObject.getString("to");
    	
    		String key;
    		if(username.compareTo(to)<0) key=username+" "+to;
    		else key=to+" "+username;
    		
    		XiangqiGameState gameState=WebSocketXiangqi.gameMap.get(key);
    		
    		WebSocketXiangqi w1=WebSocketXiangqi.socketMap.get(username),w2=WebSocketXiangqi.socketMap.get(to);
			JSONObject gameObj=new JSONObject();
			w2.setGameMapKey(key);
			
			int startx=jsonObject.getInt("startx");
			int starty=jsonObject.getInt("starty");
			int endx=jsonObject.getInt("endx");
			int endy=jsonObject.getInt("endy");
			XiangqiMove xiangqiMove=new XiangqiMove();
			xiangqiMove.setUserid(username);
			xiangqiMove.setStartx(startx);
			xiangqiMove.setStarty(starty);
			xiangqiMove.setEndx(endx);
			xiangqiMove.setEndy(endy);
			
			
			
			
			if(gameState.play(username, xiangqiMove)==true){
				gameObj.element("winner", username);
				userMapper.updateWinAddOne(username);
				if(username.equals(gameState.getA()))
					userMapper.updateFaillAddOne(gameState.getB());
				else
					userMapper.updateFaillAddOne(gameState.getA());
			}
			gameObj.element("state", gameState.getState());
			gameObj.element("A", gameState.getA());
			gameObj.element("B", gameState.getB());
			gameObj.element("type", 8);
			gameObj.element("turn", gameState.getTurn());
			System.out.println(gameObj.toString());
			w1.sendMessage(gameObj.toString());
			w2.sendMessage(gameObj.toString());
		}catch(Exception e){
			e.printStackTrace();
		}
	}

}
