<%@ page language="java" pageEncoding="UTF-8" %>
    <%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
        <!DOCTYPE html>
        <html lang="en">

        <head>
            <title></title>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">

            <script src="js/jquery-2.1.3.js"></script>
            <script type="text/javascript">
                $(document).ready(function () {
                    $(window).resize(function () {
                        var width = $(this).width();
                        var height = $(this).height();
                        //   document.getElementById("xy").innerHTML = "width" + width + "-height" + height;
                        var html = document.getElementsByTagName('html')[0];
                        var w = document.documentElement.clientWidth || document.body.clientWidth;
                        html.style.fontSize = w / 750 * 20 + "px";
                        console.log(w)
                    });
                });
            </script>
            <style>
                html {
                    font-size: 20px;
                }

                body {
                    margin: 0 0 0 0;
                }

                .container {
                    width: 100%;
                    margin: auto;
                }

                #firstCanvas_div {
                    margin: auto auto;

                    width: 30rem;
                    height: 30rem;
                }

                #firstCanvas {
                    width: 100%;
                    height: 100%;
                }

                .btn-up-div {
                    width: 100%;
                }

                button {
                    font-size: 5rem;
                    text-align: center;
                }

                div#up {
                    width: 6rem;
                    height: 6rem;
                    margin: auto;
                    /* background: url(img/up.png) no-repeat;
            background-size: 100%; */
                }

                div#down {
                    width: 6rem;
                    height: 6rem;
                    margin: auto;
                    /* background: url(img/down.png) no-repeat;
            background-size: 100%; */
                }

                div#left {
                    width: 6rem;
                    height: 6rem;
                    margin: auto;
                    /* background: url(img/left.png) no-repeat;
            background-size: 100%; */
                }

                div#right {
                    width: 6rem;
                    height: 6rem;
                    margin: auto;
                    /* background: url(img/right.png) no-repeat;
            background-size: 100%; */
                }

                div#go {
                    width: 6rem;
                    height: 6rem;
                    margin: auto;
                    /* background: url(img/go.png) no-repeat;
            background-size: 100%; */
                }

                #up,
                #down,
                #left,
                #right,
                #go {
                    text-align: center;
                    vertical-align: middle;
                    font-size: 2rem;
                    background-color: gainsboro;
                    opacity: 0.4;
                    padding-top: 1rem;
                }

                .btn-mid {
                    display: flex;
                    align-items: center;
                    flex-direction: row;
                    width: 18rem;
                    margin: auto;
                }

                div#friendlist {
                    width: 20rem;
                    overflow-y: auto;
                    position: absolute;
                    left: -20rem;
                    display: flex;
                    flex-direction: row;
                }

                button#showFriendlist {
                    width: 10rem;
                    height: 3rem;
                }

                div#hidden {
                    width: 10rem;
                    background-color: gray;
                    margin-left: 0rem;
                    height: 3rem;
                }

                #friendlist>ul {
                    list-style: none;
                    width: 10rem;
                    -webkit-padding-start: inherit;
                    margin-top: 0;
                }

                #friendlist>ul>li {
                    padding-left: 1rem;
                    background-color: white;
                    font-size: 30px;
                }
            </style>
        </head>

        <body>
            <div id="friendlist">

                <ul>
                    <c:forEach items="${list}" var="keyword">
                        <li da="${keyword.userid }">${keyword.userid }</li>

                    </c:forEach>
                </ul>
                <div id="hidden"></div>
            </div>
            <button id="showFriendlist"></button>
            <div class="container">

                <div id="firstCanvas_div">
                    <canvas id="firstCanvas" width="300" height="300"></canvas>

                </div>
                <div class="btn-up-div">
                    <div id="up" tag='dir' da='0'>up</div>
                </div>
                <div class="btn-mid">
                    <div id="left" tag='dir' da='2'>left</div>
                    <div id="go">go</div>
                    <div id="right" tag='dir' da='3'>right</div>
                </div>
                <div>
                    <div id="down" tag='dir' da='1'>down</div>
                </div>
            </div>

        </body>

        </html>
        <script>
            var username = "${username}";
            var datafrom;
            var turn;
            var friendlist = [];
            var websocket = new WebSocket("ws://localhost:8080/ssmws/websocket?username="+username);
            var chessBoard = [];
            for (var i = 0; i < 15; ++i) {
                chessBoard[i] = [];
                for (var j = 0; j < 15; ++j)
                    chessBoard[i][j] = 'o';
            }
            var newX = 7, newY = 7;

            var canvas = document.getElementById('firstCanvas');
            context = canvas.getContext('2d');
            var clean = function () {
                var drawLine = function (x1, y1, x2, y2) {
                    context.beginPath();
                    context.moveTo(x1, y1);
                    context.lineTo(x2, y2);
                    context.stroke();
                    context.closePath();



                }
                drawPoint = function (x, y, color) {
                    context.beginPath();
                    var xx = 20 * x + 10;
                    var yy = 20 * y + 10;
                    context.arc(xx, yy, 8, 0, 2 * Math.PI, true);
                    context.fillStyle = color;
                    //  context.fillStyle = 'black';
                    context.fill();
                    context.closePath();



                }
                var jiaocha = function (x, y, color) {
                    var xx = 20 * x;
                    var yy = 20 * y;
                    drawLine(xx, yy, xx + 20, yy + 20);
                    drawLine(xx, yy + 20, xx + 20, yy);
                }

                context.clearRect(0, 0, 300, 300);
                context.fillStyle = 'black';
                context.lineWidth = 2;

                for (var i = 0; i <= 300; i += 20)
                    drawLine(i, 0, i, 300);
                for (var i = 0; i <= 300; i += 20)
                    drawLine(0, i, 300, i);
                for (var i = 0; i < chessBoard.length; ++i)
                    for (var j = 0; j < chessBoard[i].length; ++j)
                        if (chessBoard[i][j] == 'a') drawPoint(j, i, "red");
                        else if (chessBoard[i][j] == 'b') drawPoint(j, i, "black");
                jiaocha(newY, newX, "blue");
            }
            clean();
            $('div[tag=dir]').click(function (e) {
                var d = $(this).attr('da')
                e.preventDefault();
                var move = [
                    [-1, 0], [1, 0], [0, -1], [0, 1]
                ];
                if (newX + move[d][0] < 0 || newX + move[d][0] >= 15 || newY + move[d][1] < 0 || newY + move[d][1] >= 15)
                    return;
                newX += move[d][0];
                newY += move[d][1];
                clean();

            });

            websocket.onopen = function () {
                console.log("success");
            }
            websocket.onmessage = function (res) {
                var data = res.data;
                data = JSON.parse(data);
                console.log(data)
                //读取在线用户列表
                if (data.type == 2) {
                    data = data.list;
                    var fl = friendlist;
                    for (var i = 0; i < fl.length; ++i) {
                        for (var j = 0; j < data.length; ++j)
                            if (data[j] == fl[i].userid) {
                                fl[i].online = true;
                                $('li[da=' + data[j] + ']').css({
                                    "background-color": 'red'
                                })
                            }
                    }

                }
                //对方上线
                else if (data.type == 1) {
                    var fl = friendlist;
                    for (var i = 0; i < fl.length; ++i) {
                        if (data.from == fl[i].userid) {
                            fl[i].online = true;
                            $('li[da=' + fl[i].userid + ']').css({
                                'background-color': 'red'
                            })

                            break;
                        }
                    }
                }
                //对方下线
                else if (data.type == 3) {
                    var fl = friendlist;
                    for (var i = 0; i < fl.length; ++i) {
                        if (data.from == fl[i].userid) {
                            fl[i].online = false;
                            $('li[da=' + fl[i].userid + ']').css({
                                'background-color': 'white'
                            })
                            break;
                        }
                    }
                }
                //对方邀请
                else if (data.type == 5) {
                    if (confirm('来自' + data.from + '的邀请')) {
                        datafrom = data.from;
                        var msg = {
                            type: 7,
                            to: datafrom

                        }
                        websocket.send(
                            JSON.stringify(msg)
                        );

                    }
                    else {
                      
                           datafrom=data.from;

                            var msg = {
                                type: 6,
                                to: datafrom

                            }
                            websocket.send(
                                JSON.stringify(msg)
                            );
                        
                    }
                }
                //start
                else if (data.type == 8) {
                    for (var i = 0; i < 15; ++i)
                        for (var j = 0; j < 15; ++j)
                            chessBoard = data.state;
                    turn = data.turn;
                    clean();
                    if (data.winner != null) {
                        alert(data.winner + 'wins')
                    }


                }

            }


            $('#go').click(function (e) {
                if (chessBoard[newX][newY] != 'o' || turn != username) return;
                var msg = {
                    type: 9,
                    to: datafrom,
                    x: newX,
                    y: newY
                }
                websocket.send(
                    JSON.stringify(msg)
                )
            });
            $('li').each(function () {
                var da = $(this).attr('da');
                friendlist.push({
                    userid: da,
                    online: false
                });
            })
            //邀请
            $('li').click(function (e) {
                var userid = $(this).attr('da');
                datafrom = userid;
                var msg = {
                    type: 4,
                    to: userid
                }
                websocket.send(
                    JSON.stringify(msg)
                )

            })
            $('#showFriendlist').click(function () {
                $('#friendlist').animate({ left: 0 })
            });
            $("#hidden").click(function () {
                $('#friendlist').animate({ left: '-20rem' })
            })
        </script>